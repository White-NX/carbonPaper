# Internationalization (i18n) Guide

This document explains how CarbonPaper handles internationalization, and how to convert hardcoded text into translatable strings.

## Stack

| Tool | Role |
|------|------|
| [i18next](https://www.i18next.com/) + [react-i18next](https://react.i18next.com/) | Runtime translation framework |
| [jscodeshift](https://github.com/facebook/jscodeshift) codemod | Automated extraction of hardcoded text into `t()` calls |
| [i18next-scanner](https://github.com/i18next/i18next-scanner) | Scans code for `t()` calls and syncs keys into locale JSON files |
| [Crowdin](https://crowdin.com/) | Translation management platform |

## File Structure

```
src/i18n/
  index.js                # i18next initialization, lazy-loads locale files
  locales/
    zh-CN.json            # Chinese (source language)
    en.json               # English
crowdin.yml               # Crowdin CLI config
scripts/
  transforms/
    i18n-jscodeshift.cjs  # Codemod transform
  i18n-check.cjs          # Locale key consistency checker
```

## NPM Scripts

```bash
npm run codemod:i18n    # Auto-wrap hardcoded text with t() calls
npm run i18n:extract    # Extract t() keys into locale JSON files
npm run i18n:check      # Verify all locale files have matching keys
```

## How to Internationalize a Component

### Automated Approach (Recommended for Bulk Work)

**Step 1 — Run the codemod on target files**

```bash
# All components (default target)
npm run codemod:i18n

# Single file
npx jscodeshift -t scripts/transforms/i18n-jscodeshift.cjs src/components/MyComponent.jsx
```

The codemod will:
- Find all JSX text nodes and translatable attribute values (`title`, `placeholder`, `alt`, `aria-label`, etc.)
- Replace them with `t('auto.generated.key', { defaultValue: 'original text' })`
- Add `import { useTranslation } from 'react-i18next'` if missing
- Inject `const { t } = useTranslation()` into React component functions (uppercase-named functions only)

> The codemod skips non-translatable attributes like `className`, `style`, `key`, `onClick`, `data-*`, etc. It also skips strings that contain no letters (pure numbers, symbols, whitespace).

**Step 2 — Review and rename keys**

The codemod generates keys in the format `components/path/File_jsx.text_1`. These are functional but not human-friendly. Rename them to semantic keys:

```jsx
// Before (auto-generated)
t('components/settings/AdvancedSection_jsx.text_3', { defaultValue: 'Python 子进程 CPU 限制' })

// After (manually renamed)
t('settings.advanced.cpuLimit.title')
```

**Step 3 — Populate locale JSON files**

Add the keys and translations to both locale files:

```jsonc
// zh-CN.json (source language)
{
  "settings": {
    "advanced": {
      "cpuLimit": {
        "title": "Python 子进程 CPU 限制"
      }
    }
  }
}

// en.json
{
  "settings": {
    "advanced": {
      "cpuLimit": {
        "title": "Python Subprocess CPU Limit"
      }
    }
  }
}
```

Once keys are in the JSON, remove the `defaultValue` fallback from the `t()` call:

```jsx
// Final
t('settings.advanced.cpuLimit.title')
```

**Step 4 — Verify**

```bash
npm run i18n:check    # Ensure all locale files have matching keys
npm run build         # Ensure no build errors
```

### Manual Approach (Recommended for Small Changes)

For individual strings, skip the codemod and do it by hand:

```jsx
import { useTranslation } from 'react-i18next';

export default function MyComponent() {
  const { t } = useTranslation();

  return <h1>{t('myComponent.title')}</h1>;
}
```

Then add the key to both `zh-CN.json` and `en.json`.

## Translation Patterns

### Basic text

```jsx
<p>{t('settings.general.description')}</p>
```

### Interpolation

```jsx
// JSON: "deleteSuccess": "成功删除 {{count}} 条记录"
<p>{t('deleteSuccess', { count: 5 })}</p>
```

### Attributes

```jsx
<input placeholder={t('search.placeholder')} />
<button title={t('actions.close')}>×</button>
```

### Strings outside JSX (event handlers, callbacks)

The `t` function from the hook works anywhere inside the component body:

```jsx
function MyComponent() {
  const { t } = useTranslation();

  const handleError = () => {
    showToast(t('errors.networkFailure'));
  };

  return <button onClick={handleError}>{t('actions.retry')}</button>;
}
```

### Non-component files (utilities, API layers)

Import the `i18n` instance directly:

```js
import i18n from '../i18n';

function formatError(code) {
  return i18n.t(`errors.${code}`);
}
```

## Key Naming Conventions

Use **dot-separated, nested keys** organized by feature area:

```
settings.general.title
settings.general.telemetry.label
settings.general.telemetry.description
settings.advanced.cpuLimit.title
settings.advanced.cpuLimit.description
search.placeholder.ocr
search.placeholder.nl
```

**Rules:**
- Group by feature/page, not by component file path
- Use camelCase for individual segments: `cpuLimit`, not `cpu_limit` or `cpu-limit`
- End leaf keys with their role when helpful: `.title`, `.description`, `.label`, `.placeholder`, `.error`

## Adding a New Language

1. Create `src/i18n/locales/{locale}.json` (e.g. `ja.json`) with the same key structure as `zh-CN.json`
2. Add the locale to `src/components/settings/LanguageSection.jsx`:
   ```js
   const LANGUAGES = [
     { value: 'zh-CN', label: '简体中文', nativeName: '简体中文' },
     { value: 'en', label: 'English', nativeName: 'English' },
     { value: 'ja', label: '日本語', nativeName: '日本語' },  // new
   ];
   ```
3. Run `npm run i18n:check` to verify key completeness

## Crowdin Workflow

The `crowdin.yml` at the project root is pre-configured. After setting up a Crowdin project:

```bash
# Upload source strings
crowdin upload sources

# Download completed translations
crowdin download
```

Crowdin reads `zh-CN.json` as the source and writes translated files (e.g. `en.json`, `ja.json`) back to `src/i18n/locales/`.

## What NOT to Translate

- CSS class names and Tailwind utilities
- Event handler names, component props
- Console log messages and developer-facing errors
- Numeric/symbolic content with no linguistic meaning
- Language names in `LanguageSection.jsx` (always shown in their native script)
